#! /usr/bin/php
<?php

require_once("SR_DHCP_Host.php");

function usage(){
	global $argv;
	echo "Usage: " . $argv[0] . " mac network
mac must be a valid MAC address.
network must be one of the competitor subnets on vlan103.
For more information, see the sr_dhcp_competitor_register (1) manpage
";
	exit();
}

if(count($argv) < 3){
	usage();
}

$MAC = $argv[1];
$network = $argv[2];

$hosts = array();
if(!is_writable("/etc/dhcp/")){
	echo "ERROR: /etc/dhcp/ is not writable - did you forget to use sudo?
";
	exit();
}
$lockFile = fopen("/etc/dhcp/subnets/team-" . $network . ".conf.lock", "a");
if(!$lockFile){
	echo "ERROR: Could not lock team-" . $network . ".conf
";
	exit();
}
if(!flock($lockFile, LOCK_EX | LOCK_NB)){
	echo "ERROR: Could not lock team-" . $network . ".conf
Locked by another process.
";
	exit();
}
ftruncate($lockFile, 0);
fwrite($lockFile, "Locked by sr_dhcp_competitor_register PID " . getmypid());

if(file_exists("/etc/dhcp/subnets/team-" . $network . ".conf")){
	$regHostsFile = file_get_contents("/etc/dhcp/subnets/team-" . $network . ".conf");
	while(strpos($regHostsFile, "}") > -1){
		$host = SR_DHCP_Host::Parse($regHostsFile);
		if($host) $hosts[] = $host;
		$regHostsFile = substr($regHostsFile, strpos($regHostsFile, "}") + 1);
	}
}

$allocated = array();
for($i=1; $i<=254; $i++)
	$allocated[$i] = false;

foreach($hosts as $host){
	if(substr($host->IPAddr, 0, strlen($baseNet)) == $baseNet){
		$suffix = (int) substr($host->IPAddr, strlen($baseNet));
		$allocated[$suffix] = true;
	}
}

$newHost = new SR_DHCP_Host();
$newHost->HWAddr = $MAC;
$splitPrefix = explode(".", $baseNet);
$newHost->Hostname = str_replace(":", "-", $MAC) . ".team" . $network . ".net.studentrobotics.org";
$hosts[] = $newHost;

$dynamic_hosts_conf = "";
foreach($hosts as $host){
	$dynamic_hosts_conf .= $host->__toString();
}
file_put_contents("/etc/dhcp/subnets/team-" . $network . ".conf", $dynamic_hosts_conf);

passthru("service isc-dhcp-server restart");

fclose($lockFile);
unlink("/etc/dhcp/subnets/team-" . $network . ".conf.lock");

?>
